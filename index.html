<!DOCTYPE html>
<html lang="en-US">
<head>
    <meta charset="utf-8" />
    <title>Chocolate VM</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .inst b {
            color: blueviolet;
        }
    </style>
</head>
<body>
    <div class="container mx-auto p-4 max-w-4xl">
        <h1 class="text-3xl font-bold mb-6">Chocolate VM Control Panel</h1>
        
        <!-- Instruction Input Section -->
        <div class="mb-6 p-4 bg-gray-100 rounded-lg">
            <h2 class="text-xl font-semibold mb-3">Add Instruction</h2>
            <div class="flex gap-4 mb-4">
                <select id="instruction" class="p-2 border rounded">
                    <option value="0">(0) - Halt</option>
                    <option value="1">(1) - Mov</option>
                    <option value="2">(2) - AddR</option>
                    <option value="3">(3) - SubR</option>
                    <option value="4">(4) - Add</option>
                    <option value="5">(5) - Sub</option>
                    <option value="6">(6) - Read</option>
                    <option value="7">(7) - Push</option>
                    <option value="8">(8) - Pop</option>
                    <option value="9">(9) - Interrupt</option>
                    <option value="10">(10) - Cmp</option>
                    <option value="11">(11) - Jmp</option>
                    <option value="12">(12) - Je</option>
                </select>
                <input type="number" id="param1" placeholder="Parameter 1" class="p-2 border rounded" />
                <input type="number" id="param2" placeholder="Parameter 2" class="p-2 border rounded" />
                <button onclick="addInstruction()" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
                    Add Instruction
                </button>
            </div>
        </div>

        <!-- Program View Section -->
        <div class="grid grid-cols-2 gap-6">
            <div class="p-4 bg-gray-100 rounded-lg">
                <h2 class="text-xl font-semibold mb-3">Program Instructions</h2>
                <pre id="programDisplay" class="bg-white p-4 rounded overflow-auto max-h-60 inst"></pre>
            </div>

            <div class="p-4 bg-gray-100 rounded-lg">
                <h2 class="text-xl font-semibold mb-3">VM State</h2>
                <pre id="vmState" class="bg-white p-4 rounded overflow-auto max-h-60">Registers will appear here...</pre>
            </div>
        </div>

        <!-- Control Buttons -->
        <div class="mt-6 flex gap-4">
            <button onclick="stepVM()" class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600">
                Step
            </button>
            <button onclick="resetVM()" class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600">
                Reset
            </button>
        </div>

        <!-- Raw Code -->
         <div class="mt-6 p-4 bg-gray-100 rounded-lg">
            <h2 class="text-xl font-semibold mb-3">Bytecode</h2>
            <pre id="rawCode" class="bg-white p-4 rounded overflow-auto max-h-60"></pre>
        </div>
    </div>

    <script type="module">
        import init, { greet, Program, VMData } from "./pkg/chocolate_libvm.js";

        let program;
        let vm;
        let isInitialized = false;

        window.initializeVM = async function() {
            await init();
            greet("WebAssembly");
            program = new Program();
            vm = new VMData();
            isInitialized = true;
            updateDisplay();
        }

        window.addInstruction = function() {
            if (!isInitialized) return;
            
            const inst = document.getElementById('instruction').value;
            const param1 = document.getElementById('param1').value || 0;
            const param2 = document.getElementById('param2').value || 0;
            
            const instruction = {
                inst: parseInt(inst),
                param_1: parseInt(param1),
                param_2: parseInt(param2)
            };
            
            program.push_instruction(JSON.stringify(instruction));
            updateDisplay();
        }

        window.stepVM = function() {
            if (!isInitialized) return;
            
            const should_continue = vm.execute_from_program(program);
            updateDisplay();
            
            if (!should_continue) {
                alert("Program halted!");
            }
        }

        window.resetVM = function() {
            if (!isInitialized) return;
            
            program = new Program();
            vm = new VMData();
            updateDisplay();
        }

        function updateDisplay() {
            // Update program display
            const programDisplay = document.getElementById('programDisplay');
            let instructions = [];
            for (let i = 0; i < program.get_inst_len(); i++) {
                instructions.push(`${vm.pc == i ? '>' : ''} ${i}: ${program.get_instruction_str(i)}`);
            }
            programDisplay.textContent = instructions.join('\n');
            programDisplay.innerHTML = instructions.join('<br>');

            // Update VM state
            const vmState = document.getElementById('vmState');
            let states = [];
            states.push(`Program Counter: ${vm.pc}`);
            states.push(`Stack Counter: ${vm.sc}`);
            for (let i = 0; i < 16; i++) {
                states.push(`Register ${i}: ${vm.read_reg(i)}`);
            }
            for (let i = 0; i < vm.sc; i++) {
                states.push(`Stack ${i}: ${vm.read_stack(i)}`);
            }
            vmState.textContent = states.join('\n');

            const raw = document.getElementById('rawCode');
            raw.textContent = program.to_raw();
        }

        // Initialize VM when page loads
        initializeVM();
    </script>
</body>
</html>